# Loki Configuration
# Optimized for Kuberblue single-node and small clusters

# Deployment mode - SingleBinary for simplicity
deploymentMode: SingleBinary

# Loki configuration
loki:
  # Multi-tenancy disabled for simplicity
  auth_enabled: false
  
  # Common configuration
  commonConfig:
    replication_factor: 1
    
  # Storage configuration
  storage:
    type: filesystem
    filesystem:
      chunks_directory: /var/loki/chunks
      rules_directory: /var/loki/rules
  
  # Storage config for TSDB
  storage_config:
    tsdb_shipper:
      active_index_directory: /var/loki/tsdb-index
      cache_location: /var/loki/tsdb-cache
  
  # Schema configuration
  schemaConfig:
    configs:
      - from: "2024-04-01"
        store: tsdb
        object_store: filesystem
        schema: v13
        index:
          prefix: loki_index_
          period: 24h
  
  # Limits configuration
  limits_config:
    # Retention period (30 days)
    retention_period: 720h
    # Ingestion limits
    ingestion_rate_mb: 10
    ingestion_burst_size_mb: 20
    # Query limits
    max_query_series: 5000
    max_query_parallelism: 32
    # Per-stream limits
    per_stream_rate_limit: 5MB
    per_stream_rate_limit_burst: 10MB
  
  # Compactor configuration (retention disabled for simplicity)
  compactor:
    retention_enabled: false
    compaction_interval: 10m
  
  # Query scheduler
  query_scheduler:
    max_outstanding_requests_per_tenant: 2048
  
  # Frontend configuration
  frontend:
    max_outstanding_per_tenant: 2048
  
  # Ruler configuration (for alerting rules)
  ruler:
    enable_api: true
    enable_alertmanager_v2: true
    alertmanager_url: http://mimir-alertmanager.monitoring:8080/alertmanager
    storage:
      type: local
      local:
        directory: /var/loki/rules
    rule_path: /var/loki/rules-temp

# Explicitly disable SimpleScalable components
write:
  replicas: 0

read:
  replicas: 0

backend:
  replicas: 0

# Single Binary deployment configuration
singleBinary:
  replicas: 1

  
  # Persistence
  persistence:
    enabled: true
    size: 50Gi
    storageClass: ""  # Use default
  
  # Resources
  resources:
    requests:
      cpu: 25m
      memory: 128Mi
    limits:
      cpu: 100m
      memory: 256Mi
  
  # Extra volumes for rules
  extraVolumes:
    - name: rules
      emptyDir: {}
  
  extraVolumeMounts:
    - name: rules
      mountPath: /var/loki/rules

# Gateway configuration
gateway:
  enabled: true
  replicas: 1
  
  # Resources
  resources:
    requests:
      cpu: 25m
      memory: 32Mi
    limits:
      cpu: 50m
      memory: 64Mi
  
  # Service configuration
  service:
    type: ClusterIP
    port: 80
  
  # Basic auth disabled
  basicAuth:
    enabled: false

# Monitoring
monitoring:
  serviceMonitor:
    enabled: false  # Disabled - Alloy-first architecture
  
  # Self monitoring
  selfMonitoring:
    enabled: false  # Avoid circular dependency
    
  # Loki canary for testing
  lokiCanary:
    enabled: true
    resources:
      requests:
        cpu: 12m
        memory: 32Mi
      limits:
        cpu: 50m
        memory: 64Mi

# Disable memcached for resource constraints
memcached:
  enabled: false

memcachedChunks:
  enabled: false

memcachedFrontend:
  enabled: false

memcachedIndexQueries:
  enabled: false

memcachedIndexWrites:
  enabled: false

# Test configuration
test:
  enabled: false  # We use Chainsaw tests instead

# Pod Security
podSecurityContext:
  runAsNonRoot: true
  runAsUser: 10001
  fsGroup: 10001
  seccompProfile:
    type: RuntimeDefault

# Container Security
containerSecurityContext:
  allowPrivilegeEscalation: false
  capabilities:
    drop:
    - ALL
  readOnlyRootFilesystem: true

# Network policies
networkPolicy:
  enabled: false  # Can be enabled based on requirements

# Service Account
serviceAccount:
  create: true
  automountServiceAccountToken: true