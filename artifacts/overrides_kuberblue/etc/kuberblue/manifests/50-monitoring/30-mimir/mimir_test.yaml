apiVersion: chainsaw.kyverno.io/v1alpha1
kind: Test
metadata:
  name: mimir-metrics-storage-test
  annotations:
    kuberblue.test/component: "mimir"
    kuberblue.test/category: "monitoring"
    kuberblue.test/priority: "high"
    kuberblue.test/timeout: "600s"
spec:
  timeouts:
    apply: 60s
    assert: 300s
    cleanup: 60s
  steps:
  
  # Step 1: Verify Mimir components are deployed
  - name: verify-mimir-deployment
    try:
    - assert:
        resource:
          apiVersion: apps/v1
          kind: StatefulSet
          metadata:
            name: mimir-ingester
            namespace: monitoring
          status:
            readyReplicas: 1
    - assert:
        resource:
          apiVersion: apps/v1
          kind: StatefulSet
          metadata:
            name: mimir-store-gateway
            namespace: monitoring
          status:
            readyReplicas: 1
    - assert:
        resource:
          apiVersion: apps/v1
          kind: StatefulSet
          metadata:
            name: mimir-compactor
            namespace: monitoring
          status:
            readyReplicas: 1
    - assert:
        resource:
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: mimir-distributor
            namespace: monitoring
          status:
            readyReplicas: 1
    - assert:
        resource:
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: mimir-querier
            namespace: monitoring
          status:
            readyReplicas: 1
    - assert:
        resource:
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: mimir-query-frontend
            namespace: monitoring
          status:
            readyReplicas: 1
            
  # Step 2: Verify services are available
  - name: verify-mimir-services
    try:
    - assert:
        resource:
          apiVersion: v1
          kind: Service
          metadata:
            name: mimir-distributor
            namespace: monitoring
    - assert:
        resource:
          apiVersion: v1
          kind: Service
          metadata:
            name: mimir-query-frontend
            namespace: monitoring
    - assert:
        resource:
          apiVersion: v1
          kind: Service
          metadata:
            name: mimir-gateway
            namespace: monitoring
            
  # Step 3: Test metric ingestion
  - name: test-metric-ingestion
    try:
    - apply:
        resource:
          apiVersion: v1
          kind: Pod
          metadata:
            name: mimir-test-client
            namespace: monitoring
          spec:
            restartPolicy: Never
            containers:
            - name: test
              image: curlimages/curl:latest
              command:
              - sh
              - -c
              - |
                # Create test metric in Prometheus format
                cat > /tmp/metrics.txt << EOF
                # HELP test_metric Test metric for Mimir
                # TYPE test_metric gauge
                test_metric{job="test",instance="test"} 42
                EOF
                
                # Send metric to Mimir distributor
                curl -X POST -H "Content-Type: text/plain" \
                  --data-binary @/tmp/metrics.txt \
                  http://mimir-distributor:8080/api/v1/push
                
                # Wait for ingestion
                sleep 10
                
                # Query the metric back
                curl -G http://mimir-query-frontend:8080/prometheus/api/v1/query \
                  --data-urlencode 'query=test_metric{job="test"}'
              resources:
                requests:
                  memory: "64Mi"
                  cpu: "50m"
                limits:
                  memory: "128Mi"
                  cpu: "100m"
    - assert:
        resource:
          apiVersion: v1
          kind: Pod
          metadata:
            name: mimir-test-client
            namespace: monitoring
          status:
            phase: Succeeded
            
  # Step 4: Verify persistent volumes
  - name: verify-persistent-storage
    try:
    - assert:
        resource:
          apiVersion: v1
          kind: PersistentVolumeClaim
          metadata:
            namespace: monitoring
          status:
            phase: Bound
    - script:
        timeout: 30s
        content: |
          # Check that all Mimir PVCs are bound
          kubectl get pvc -n monitoring -l app.kubernetes.io/name=mimir-distributed -o json | \
            jq -e '.items | length > 0 and all(.status.phase == "Bound")' || exit 1
          echo "All Mimir PVCs are bound"
          
  cleanup:
  - delete:
      ref:
        apiVersion: v1
        kind: Pod
        name: mimir-test-client
        namespace: monitoring