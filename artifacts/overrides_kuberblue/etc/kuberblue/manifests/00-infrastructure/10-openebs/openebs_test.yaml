apiVersion: chainsaw.kyverno.io/v1alpha1
kind: Test
metadata:
  name: openebs-storage-test
  annotations:
    kuberblue.test/component: "openebs"
    kuberblue.test/category: "storage"
    kuberblue.test/priority: "high"
    kuberblue.test/timeout: "300s"
spec:
  timeouts:
    apply: 60s
    assert: 300s
    cleanup: 60s
  steps:
  
  # Step 1: Verify OpenEBS components
  - name: verify-openebs-deployment
    try:
    - assert:
        resource:
          apiVersion: storage.k8s.io/v1
          kind: StorageClass
          metadata:
            name: openebs-hostpath
          provisioner: openebs.io/local
    - assert:
        resource:
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: openebs-localpv-provisioner
            namespace: openebs
          status:
            readyReplicas: 1
            
  # Step 2: Test PVC provisioning
  - name: test-pvc-provisioning
    try:
    - apply:
        resource:
          apiVersion: v1
          kind: Namespace
          metadata:
            name: openebs-test
    - apply:
        resource:
          apiVersion: v1
          kind: PersistentVolumeClaim
          metadata:
            name: test-pvc
            namespace: openebs-test
          spec:
            accessModes: ["ReadWriteOnce"]
            storageClassName: openebs-hostpath
            resources:
              requests:
                storage: 1Gi
    - assert:
        resource:
          apiVersion: v1
          kind: PersistentVolumeClaim
          metadata:
            name: test-pvc
            namespace: openebs-test
          status:
            phase: Bound
            
  # Step 3: Test volume mounting
  - name: test-volume-mounting
    try:
    - apply:
        resource:
          apiVersion: v1
          kind: Pod
          metadata:
            name: storage-test-pod
            namespace: openebs-test
          spec:
            containers:
            - name: test-container
              image: busybox:latest
              command:
              - sh
              - -c
              - |
                echo "Testing storage..." > /data/test.txt &&
                cat /data/test.txt &&
                sleep 30
              volumeMounts:
              - name: test-volume
                mountPath: /data
              resources:
                requests:
                  memory: "64Mi"
                  cpu: "50m"
                limits:
                  memory: "128Mi"
                  cpu: "100m"
            volumes:
            - name: test-volume
              persistentVolumeClaim:
                claimName: test-pvc
            restartPolicy: Never
    - assert:
        resource:
          apiVersion: v1
          kind: Pod
          metadata:
            name: storage-test-pod
            namespace: openebs-test
          status:
            phase: Succeeded
    - script:
        timeout: 60s
        content: |
          # Verify file was written successfully
          kubectl logs storage-test-pod -n openebs-test | grep "Testing storage..." || exit 1
          echo "Volume mounting and I/O verified"
          
  cleanup:
  - delete:
      ref:
        apiVersion: v1
        kind: Namespace
        name: openebs-test