#!/bin/bash
set -euxo pipefail

TAILSCALE_MODE=0

type syncthing >/dev/null 2>/dev/null
if [[ $? -ne 0 ]]
then 
    echo "syncthing is not present...exiting"
    exit
fi


type tailscale >/dev/null 2>/dev/null
if [[ $? -eq 0 ]]
then 
    echo "tailscale is present, checking for backend state"
    if [[ "$(tailscale status --json | jq .BackendState)" == "\"Running\"" ]]
    then
        echo "tailscale backend state is running, checking for ip"
        if [[ "$(tailscale ip -4)" =~ ^100\. ]]
        then
            echo "tailscale ip is present, using tailscale mode"
            TAILSCALE_MODE=1
        fi
    fi
else
    echo "tailscale not on this system, skipping further checks."
fi

if [[ $TAILSCALE_MODE -eq 1 ]]
then
    tailscale_ip_trimmed=$(tailscale ip -4 | head -n1 | xargs)
    /usr/bin/syncthing serve --no-browser --no-restart --logflags=0 --gui-address="http://${tailscale_ip_trimmed}:8384"
    exit $?
else
    /usr/bin/syncthing serve --no-browser --no-restart --logflags=0
    exit $?
fi

